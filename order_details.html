<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-light">
  <div class="container mt-4">
    <a href="index.html" class="btn btn-outline-primary mb-4 shadow-sm px-4 py-2 rounded-pill fw-semibold">
      <i class="fas fa-arrow-left"></i> Quay lại Trang chính
    </a>

    <h2 class="text-primary mb-4"><i class="fas fa-list"></i> Chi tiết Đơn hàng</h2>

    <form id="addOrderDetailForm" class="card p-4 shadow-sm mb-4">
      <input type="hidden" id="edit_order_id">
      <input type="hidden" id="edit_product_id">
      <h5 class="mb-3" id="formTitle">Thêm Chi Tiết Đơn Hàng</h5>
      <div class="mb-3">
        <label for="order_id" class="form-label">Order ID</label>
        <select class="form-control" id="order_id" required>
          <option value="">-- Chọn Order ID --</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="product_id" class="form-label">Product ID</label>
        <select class="form-control" id="product_id" required>
          <option value="">-- Chọn Product ID --</option>
        </select>
        <div id="stockInfo" class="form-text text-primary"></div>
      </div>
      <div class="mb-3">
        <label for="quantity" class="form-label">Số lượng</label>
        <input type="number" class="form-control" id="quantity" required>
      </div>
      <div class="mb-3">
        <label for="unit_price" class="form-label">Đơn giá</label>
        <input type="number" step="0.01" class="form-control" id="unit_price" required readonly>
      </div>
      <div class="mb-3">
        <label for="discount" class="form-label">Giảm giá (%)</label>
        <input type="number" step="0.01" class="form-control" id="discount">
      </div>
      <button type="submit" class="btn btn-success" id="submitBtn"><i class="fas fa-plus"></i> Thêm Chi Tiết</button>
      <button type="button" class="btn btn-secondary ms-2 d-none" id="cancelEditBtn">Huỷ</button>
    </form>

    <table class="table table-hover shadow-sm bg-white">
      <thead class="table-primary">
        <tr>
          <th scope="col">#</th>
          <th scope="col">Order ID</th>
          <th scope="col">Product ID</th>
          <th scope="col">Số lượng</th>
          <th scope="col">Đơn giá</th>
          <th scope="col">Giảm giá</th>
          <th scope="col">Hành động</th>
        </tr>
      </thead>
      <tbody id="orderDetailTableBody">
        <!-- Dữ liệu sẽ hiển thị ở đây -->
      </tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script>
    const tableBody = document.getElementById('orderDetailTableBody');
    const form = document.getElementById('addOrderDetailForm');
    const editOrderId = document.getElementById('edit_order_id');
    const editProductId = document.getElementById('edit_product_id');
    const formTitle = document.getElementById('formTitle');
    const submitBtn = document.getElementById('submitBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');

    function formatVND(amount) {
      if (!amount) return "";
      return Number(amount).toLocaleString('vi-VN') + " VNĐ";
    }

    function loadOrderIds() {
      fetch('http://localhost/qlkh/php/orders/get_orders.php')
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById('order_id');
          select.innerHTML = '<option value="">-- Chọn Order ID --</option>';
          data.forEach(order => {
            select.innerHTML += `<option value="${order.order_id}">${order.order_id} (${order.customer_id} ${order.full_name || ""})</option>`;
          });
        });
    }

    function loadProductIds() {
      fetch('http://localhost/qlkh/php/products/get_products.php')
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById('product_id');
          select.innerHTML = '<option value="">-- Chọn Product ID --</option>';
          data.forEach(product => {
            select.innerHTML += `<option value="${product.product_id}" data-stock="${product.stock_quantity}" data-price="${product.price}">${product.product_id} (${product.name})</option>`;
          });
        });
    }

    // Hiển thị tồn kho khi chọn sản phẩm
    document.getElementById('product_id').addEventListener('change', function () {
      const selected = this.options[this.selectedIndex];
      const stock = selected.getAttribute('data-stock');
      document.getElementById('stockInfo').textContent = stock ? `Tồn kho: ${stock}` : '';
      // Tự động cập nhật đơn giá khi chọn sản phẩm mới
      updateUnitPrice();
    });

    // Tự động cập nhật đơn giá khi nhập số lượng hoặc chọn sản phẩm
    document.getElementById('quantity').addEventListener('input', function () {
      checkStock();
      updateUnitPrice();
    });

    function checkStock() {
      const productSelect = document.getElementById('product_id');
      const stock = Number(productSelect.options[productSelect.selectedIndex]?.getAttribute('data-stock') || 0);
      const quantity = Number(document.getElementById('quantity').value);
      if (stock && quantity > stock) {
        document.getElementById('quantity').setCustomValidity('Số lượng đặt vượt quá tồn kho!');
      } else {
        document.getElementById('quantity').setCustomValidity('');
      }
    }

    function updateUnitPrice() {
      const productSelect = document.getElementById('product_id');
      const price = Number(productSelect.options[productSelect.selectedIndex]?.getAttribute('data-price') || 0);
      const quantity = Number(document.getElementById('quantity').value);
      document.getElementById('unit_price').value = quantity && price ? quantity * price : '';
    }

    function loadOrderDetails() {
      fetch('http://localhost/qlkh/php/order_details/get_order_details.php')
        .then(res => res.json())
        .then(data => {
          tableBody.innerHTML = '';
          data.forEach((item, index) => {
            tableBody.innerHTML += `
              <tr>
                <th>${index + 1}</th>
                <td>${item.order_id}</td>
                <td>${item.product_id}</td>
                <td>${item.quantity}</td>
                <td>${formatVND(item.unit_price)}</td>
                <td>${item.discount}</td>
                <td>
                  <button class='btn btn-sm btn-warning me-1' title="Sửa"
                    data-order-id='${item.order_id}'
                    data-product-id='${item.product_id}'
                    data-quantity='${item.quantity}'
                    data-unit-price='${item.unit_price}'
                    data-discount='${item.discount || ""}'
                    onclick='editDetail(this)'><i class="fas fa-edit"></i></button>
                  <button class='btn btn-sm btn-danger' title="Xóa"
                    data-order-id='${item.order_id}'
                    data-product-id='${item.product_id}'
                    onclick='deleteDetail(this)'><i class="fas fa-trash-alt"></i></button>
                </td>
              </tr>
            `;
          });
        });
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      checkStock();

      const productSelect = document.getElementById('product_id');
      const stock = Number(productSelect.options[productSelect.selectedIndex]?.getAttribute('data-stock') || 0);
      const quantity = Number(document.getElementById('quantity').value);

      if (stock && quantity > stock) {
        alert('Số lượng đặt vượt quá tồn kho!');
        return;
      }

      const order_id = document.getElementById('order_id').value;
      const product_id = document.getElementById('product_id').value;
      const price = Number(productSelect.options[productSelect.selectedIndex]?.getAttribute('data-price') || 0);
      const unit_price = quantity * price;
      const discount = document.getElementById('discount').value;

      if (editOrderId.value && editProductId.value) {
        // Update
        fetch(`http://localhost/qlkh/php/order_details/update_order_detail.php?order_id=${editOrderId.value}&product_id=${editProductId.value}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_id, product_id, quantity, unit_price, discount })
        })
          .then(res => res.json())
          .then(data => {
            alert(data.message || 'Cập nhật thành công!');
            form.reset();
            editOrderId.value = '';
            editProductId.value = '';
            formTitle.textContent = 'Thêm Chi Tiết Đơn Hàng';
            submitBtn.innerHTML = '<i class="fas fa-plus"></i> Thêm Chi Tiết';
            cancelEditBtn.classList.add('d-none');
            loadOrderDetails();
            updateOrderTotal(order_id);
          });
      } else {
        // Thêm mới
        fetch('http://localhost/qlkh/php/order_details/create_order_detail.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_id, product_id, quantity, unit_price, discount })
        })
          .then(res => res.json())
          .then(data => {
            alert(data.message || 'Thêm chi tiết đơn hàng thành công!');
            form.reset();
            loadOrderDetails();
            updateOrderTotal(order_id);
          });
      }
    });

    window.editDetail = function (button) {
      const order_id = button.getAttribute('data-order-id');
      const product_id = button.getAttribute('data-product-id');
      const quantity = button.getAttribute('data-quantity');
      const unit_price = button.getAttribute('data-unit-price');
      const discount = button.getAttribute('data-discount');

      document.getElementById('order_id').value = order_id;
      document.getElementById('product_id').value = product_id;
      document.getElementById('quantity').value = quantity;
      document.getElementById('unit_price').value = unit_price;
      document.getElementById('discount').value = discount;

      editOrderId.value = order_id;
      editProductId.value = product_id;
      formTitle.textContent = 'Sửa Chi Tiết Đơn Hàng';
      submitBtn.innerHTML = '<i class="fas fa-save"></i> Lưu';
      cancelEditBtn.classList.remove('d-none');
      updateUnitPrice();
    };

    window.deleteDetail = function (button) {
      const order_id = button.getAttribute('data-order-id');
      const product_id = button.getAttribute('data-product-id');
      if (confirm("Bạn có chắc muốn xoá chi tiết này?")) {
        fetch(`http://localhost/qlkh/php/order_details/delete_order_detail.php?order_id=${order_id}&product_id=${product_id}`, {
          method: 'DELETE',
        })
          .then(res => res.json())
          .then(data => {
            alert(data.message || 'Xóa thành công!');
            loadOrderDetails();
            updateOrderTotal(order_id);
          });
      }
    };

    cancelEditBtn.addEventListener('click', function () {
      form.reset();
      editOrderId.value = '';
      editProductId.value = '';
      formTitle.textContent = 'Thêm Chi Tiết Đơn Hàng';
      submitBtn.innerHTML = '<i class="fas fa-plus"></i> Thêm Chi Tiết';
      cancelEditBtn.classList.add('d-none');
      updateUnitPrice();
    });

    function updateOrderTotal(order_id) {
      fetch(`http://localhost/qlkh/php/orders/update_order_total.php?order_id=${order_id}`)
        .then(res => res.json())
        .then(data => {
          // Nếu muốn, có thể reload lại bảng orders ở trang khác
          if (window.loadOrders) loadOrders();
        });
    }

    // Khởi tạo dữ liệu
    loadOrderIds();
    loadProductIds();
    loadOrderDetails();
  </script>
</body>
</html>