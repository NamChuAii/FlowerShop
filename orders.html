<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orders</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-light">
  <div class="container mt-4">
    <a href="index.html" class="btn btn-outline-primary mb-4 shadow-sm px-4 py-2 rounded-pill fw-semibold">
      <i class="fas fa-arrow-left"></i> Quay lại Trang chính
    </a>

    <h2 class="text-primary mb-4"><i class="fas fa-truck"></i> Danh sách Đơn hàng</h2>

    <form id="orderForm" class="card p-4 shadow-sm mb-4">
      <h5 class="mb-3">Thêm / Sửa Đơn hàng</h5>
      <input type="hidden" id="order_id">
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">Customer ID</label>
          <input class="form-control" id="customer_id" type="number" placeholder="ID khách hàng">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Employee ID</label>
          <input class="form-control" id="employee_id" type="number" placeholder="ID nhân viên">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Ngày đặt</label>
          <input class="form-control" id="order_date" type="date">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Trạng thái</label>
          <select class="form-control" id="status">
            <option value="0">Chưa thanh toán</option>
            <option value="1">Đã thanh toán</option>
            <option value="2">Đang chờ thanh toán</option>
          </select>
        </div>
        <div class="col-md-4 mb-3 d-flex align-items-end">
          <button type="submit" class="btn btn-success w-100"><i class="fas fa-save"></i> Lưu</button>
        </div>
      </div>
    </form>

    <table class="table table-hover shadow-sm bg-white">
      <thead class="table-primary">
        <tr>
          <th>Order ID</th>
          <th>Customer ID</th>
          <th>Employee</th>
          <th>Ngày</th>
          <th>Trạng thái</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody id="orderTable"></tbody>
    </table>
    
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    function formatVND(amount) {
      if (!amount) return "";
      return Number(amount).toLocaleString('vi-VN') + " VNĐ";
    }
function renderStatus(status) {
  const s = String(status).trim(); // ép kiểu và loại bỏ khoảng trắng
  switch (s) {
    case "0": return "❌ Chưa thanh toán";
    case "1": return "✅ Đã thanh toán";
    case "2": return "⏳ Đang chờ thanh toán";
    default: return "❔ Không xác định";
  }
}


function loadOrders() {
  $.get("http://localhost/qlkh/php/orders/get_orders.php", function(data) {
    if (!Array.isArray(data)) {
      try {
        data = JSON.parse(data);
      } catch (e) {
        alert("Lỗi dữ liệu trả về từ server!");
        return;
      }
    }
    const tbody = $("#orderTable").empty();
    data.forEach(o => {
      tbody.append(`<tr>
        <td>${o.order_id}</td>
        <td>${o.customer_id}</td>
        <td>${o.employee_id}</td>
        <td>${o.order_date}</td>
        <td>${renderStatus(o.status)}</td>
        <td>
          <button class="btn btn-sm btn-warning me-1" title="Sửa" onclick="editOrder(${o.order_id})"><i class="fas fa-edit"></i></button>
          <button class="btn btn-sm btn-danger" title="Xóa" onclick="deleteOrder(${o.order_id})"><i class="fas fa-trash"></i></button>
        </td>
      </tr>`);
    });
  });
}

function editOrder(id) {
  $.get("http://localhost/qlkh/php/orders/get_orders.php", function(data) {
    if (!Array.isArray(data)) {
      try {
        data = JSON.parse(data);
      } catch (e) {
        alert("Lỗi dữ liệu trả về từ server!");
        return;
      }
    }
    const o = data.find(x => x.order_id == id);
    if (o) {
      $("#order_id").val(o.order_id);
      $("#customer_id").val(o.customer_id);
      $("#employee_id").val(o.employee_id);
      // Sửa tại đây: chỉ lấy phần ngày (yyyy-MM-dd)
      $("#order_date").val(o.order_date ? o.order_date.substring(0, 10) : "");
      $("#status").val(o.status);
      $("#total_amount").val(o.total_amount);
    }
  });
}

function deleteOrder(id) {
  if (confirm("Xoá đơn hàng này?")) {
    $.ajax({
      url: `http://localhost/qlkh/php/orders/delete_order.php?order_id=${id}`,
      type: "DELETE",
      success: res => {
        alert(res.message);
        loadOrders();
      }
    });
  }
}

$("#orderForm").submit(function(e) {
  e.preventDefault();
  const id = $("#order_id").val();
  const payload = {
    customer_id: $("#customer_id").val(),
    employee_id: $("#employee_id").val(),
    order_date: $("#order_date").val(),
    status: $("#status").val(),
    total_amount: $("#total_amount").val()
  };
  const url = id 
    ? `http://localhost/qlkh/php/orders/update_order.php?order_id=${id}`
    : "http://localhost/qlkh/php/orders/create_order.php";

  $.ajax({
    url: url,
    type: id ? "PUT" : "POST",
    contentType: "application/json",
    data: JSON.stringify(payload),
    success: res => {
      alert(res.message);
      $("#orderForm")[0].reset();
      loadOrders();
    }
  });
});

$(document).ready(loadOrders);
</script>
</body>
</html>